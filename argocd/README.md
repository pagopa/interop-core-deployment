# Interop Core – ArgoCD

This document describes the structure of the `argocd` directory and how to install/sync the project on a Kubernetes cluster where ArgoCD is already installed.

## Overview

The `argocd` folder contains the ArgoCD resources needed to:
- publish environment-wide ConfigMaps;
- declaratively generate an `ApplicationSet` that creates one `Application` for each microservice in the repo;
- expose a root `Application` that ArgoCD uses to orchestrate everything.

## Structure

- [argocd/root-app.yaml](root-app.yaml)
  - Creates the root `Application` `interop-appset-reposerver-root` in the ArgoCD namespace (default here: `dev-experimental-argocd`).
  - Uses multiple `sources`:
    - Includes and applies plain manifests (e.g., `common-cm.yaml`).
    - Includes the `ApplicationSet` (`microservices-appset.yaml`) that generates the microservices applications.
  - Sets useful `syncOptions` (e.g., `CreateNamespace=true`).

- [argocd/common-cm.yaml](common-cm.yaml)
  - Plain K8s manifests (e.g., shared ConfigMaps) applied as-is by the ArgoCD repo-server.

- [argocd/microservices-appset.yaml](microservices-appset.yaml)
  - `ApplicationSet` that scans directories under `microservices/*` and generates one `Application` per microservice.
  - For each microservice:
    - Helm source: `interop-eks-microservice-chart` (repo: `https://pagopa.github.io/interop-eks-microservice-chart`, `targetRevision: 1.33.0`).
    - `valueFiles` taken from this repo (e.g., `commons/dev/values-microservice.yaml` and `microservices/<svc>/dev/values.yaml`).
    - Inline values: dynamically sets `deployment.image.tag` from `commons/dev/images.yaml` (key `images.microservices.<svc>.tag`).
    - Parameters (`name`, `releaseName`) aligned to the microservice folder basename.
  - Default Kubernetes destination namespace: `dev-experimental-argocd-interop-apps`.


## Environment Conventions

- ArgoCD namespace (where ArgoCD CRDs and `Application`/`ApplicationSet` live): `dev-experimental-argocd`.
- Default target namespace for microservices: `dev-experimental-argocd-interop-apps`.
- Repository branch/revision used in manifests: currently set to `feature/argocd` (change as needed).

## Note on `targetRevision`

- `targetRevision` determines exactly which branch/tag/commit SHA ArgoCD uses to read repository manifests.
- If you work on a branch different from the configured one, update the `targetRevision` field in [root-app.yaml](root-app.yaml) and/or in [microservices-appset.yaml](microservices-appset.yaml), or move your changes to the observed branch.
- ArgoCD applies only content pushed to the remote: local changes have no effect until you `git push` to the configured branch.
- For repeatable/immutable releases, consider using a tag or a commit SHA directly in `targetRevision`.

## Prerequisites

- Kubernetes cluster reachable with `kubectl` configured.
- ArgoCD already installed on the cluster (operator or standard install) and the ArgoCD namespace exists (in this doc: `dev-experimental-argocd`).
- Permissions to create ArgoCD resources (`Application`, `ApplicationSet`, `AppProject`) in the ArgoCD namespace.

## Installation

1) Clone the repo and move to the project root

```bash
git clone https://github.com/pagopa/interop-core-deployment.git
cd interop-core-deployment
```

2) (Optional) Check/update the branch/revision in ArgoCD files

- In [argocd/root-app.yaml](root-app.yaml) and [argocd/microservices-appset.yaml](microservices-appset.yaml), `targetRevision` is set to `feature/argocd`. If you work on a different branch, update it accordingly.

3) Apply the root Application

```bash
# Apply the root Application (the manifest already contains metadata.namespace)
kubectl apply -f argocd/root-app.yaml

# Alternatively, explicitly set the ArgoCD namespace
# kubectl apply -n dev-experimental-argocd -f argocd/root-app.yaml
```

4) Verify that ArgoCD created the resources

```bash
kubectl -n dev-experimental-argocd get applications,applicationsets,appprojects
```

5) Sync the applications

- If autosync is not enabled, open the ArgoCD UI and click “Sync” on `interop-appset-reposerver-root` and the apps generated by the `ApplicationSet`.
- Alternatively, with the `argocd` CLI (if configured):

```bash
# Example (replace APP_NAME with the actual application name)
argocd app sync interop-appset-reposerver-root
# or
argocd app sync APP_NAME
```

## Updates

- Changes under `commons/` or `microservices/` are picked up by ArgoCD on the next reconciliation based on the configured `targetRevision`.
- You can force a refresh from the ArgoCD UI or with CLI:

```bash
argocd app refresh interop-appset-reposerver-root
```

## Notes

- If you need to target different environments/namespaces, update the `destination.namespace` in the `Application`/`ApplicationSet` manifests, and adjust values files references (e.g., under `commons/<env>/` and `microservices/<svc>/<env>/`).
- For local Helm rendering tests, use the scripts under `scripts/helm/` or run `helm template` with the corresponding `valueFiles`.
